{% extends 'base.html' %}

{% block content %}
<code>{{ path }}</code>
<nav id="pagenav">
    <a onclick="edit()">Edit</a> | 
    <a onclick="pa.boolean('! ACHTUNG !<br />Wirklich lÃ¶schen?', 'delete');">Delete</a>
</nav>
<div id="content">
{{ content|safe }}
</div>
<div id="meta">
    <p>Loading meta-information...</p>
</div>

<script src="{{ relroot }}_static/polalert.js"></script>
<script>
    var path = '{{ path }}';
    var relroot = '{{ relroot }}';
    var sourceUrl = '{{ relroot }}_getSource/{{ path }}';
    var updateUrl = '{{ relroot }}_updatePage/{{ path }}';
    var updateMetaUrl = '{{ relroot }}_updateMeta/{{ path }}';
    var deleteUrl = '{{ relroot }}_delete/{{ path }}';
    var meta = {{ meta|safe }};
    
    function showMeta() {
        var m = document.getElementById('meta');
        var found = false;
        var out = '<hr />\n<a onclick="editMeta()">Edit Meta</a>';
        out += '<h2>Meta-information</h2>';
        out += '<h3>Description</h3>'
        if (meta.hasOwnProperty('description')){
            found = true;
            out += meta.description;
        }else{
            out += '<p>-</p>'
        }
        out += '<h3>Keywords</h3>';
        if (meta.hasOwnProperty('keywords')){
            found = true;
            out += meta.keywords;
        }else{
            out += '<p>-</p>';
        }
        if (found) {
            m.innerHTML=out;
        }else{
            m.innerHTML='<hr />\n<a onclick="editMeta()">Add Meta</a>';
        }
    }
    showMeta();
    function editMeta() {
        var m = document.getElementById('meta');
        var out = '<hr />'
        out += '<textarea name="description" id="description" class="formdata" rows="5">';
        if (meta.hasOwnProperty('description')){
            out += meta.description;
        }else{
            out += ''
        }
        out += '</textarea>';
        out += '<textarea name="keywords" id="keywords" class="formdata" rows="2">';
        if (meta.hasOwnProperty('keywords')){
            out += meta.keywords;
        }else{
            out += ''
        }
        out += '</textarea>';
        out += '<div style="clear:both;"><input type="submit" value="Speichern" onclick="saveMeta()"></div>\n';
        m.innerHTML = out;
    }
    
    const edit = async () => {
        const response = await fetch(sourceUrl);
        const source = await response.text();
        content = '<div style="clear:both;"><textarea path="source" id="source" class="formdata" rows="20">\n';
        content = content+source;
        content = content+'</textarea></div>';
        content = content+'<div style="clear:both;"><input type="submit" value="Speichern" onclick="save()"></div>\n';
        document.getElementById('content').innerHTML = content;
    }
    async function save() {
        const response = await fetch(updateUrl, {
            method: 'PUT', // *GET, POST, PUT, DELETE, etc.
            mode: 'cors', // no-cors, *cors, same-origin
            cache: 'default', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'text/plain'
            },
            body: document.getElementById('source').value
        });
        location.reload();
        //return response.json(); // parses JSON response into native JavaScript objects
    }
    function paOk(str) {
        if (str == 'delete') {
            deletePage();
        }
    }
    function paNo(str) {
        pa.message('Ok, nichts passiert!');
    }
    async function deletePage() {
        const response = await fetch(deleteUrl, {
            method: 'DELETE', // *GET, POST, PUT, DELETE, etc.
        });
        window.location.href = relroot;
    }
    async function saveMeta() {
        var desc = document.getElementById('description').value;
        var keyw = document.getElementById('keywords').value;
        var m = {'description':desc, 'keywords':keyw};
        const response = await fetch(updateMetaUrl, {
            method: 'PUT', // *GET, POST, PUT, DELETE, etc.
            mode: 'cors', // no-cors, *cors, same-origin
            cache: 'default', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'text/plain'
            },
            body: JSON.stringify(m)
        });
        location.reload();
    }
</script>
{% endblock %}

